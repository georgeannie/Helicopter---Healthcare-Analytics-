#--------------------------------------------------------------------------------#
#                     FEATURE ENGINEERING FUNCTIONS                              #
#--------------------------------------------------------------------------------#
library(geosphere)
library(rlist)

#--------------------------------------------------------------------------------#
#  EXTRACT ELEMENTS FROM EACH ROW OF LIST TYPE COLUMN OR DATA FRAME TYPE COLUMN  #
#--------------------------------------------------------------------------------#

list_extract <- function(column, position = 1, rownum = 1){
  
  if(position==0){
    stop("position 0 is not supported")
  }
  
  if(is.data.frame(column[[1]])){
    if(position<0){
      sapply(column, function(column){
        index <- ncol(column) + position + 1
        if(is.null(column[rownum, index]) | index <= 0){
          # column[rownum, position] still returns data frame if it's minus, so position < 0 should be caught here
          NA
        } else {
          column[rownum, index][[1]]
        }
      })
    } else {
      sapply(column, function(column){
        if(is.null(column[rownum, position])){
          NA
        } else {
          column[rownum, position][[1]]
        }
      })
    }
  } else {
    if(position<0){
      sapply(column, function(column){
        index <- length(column) + position + 1
        if(index <= 0){
          # column[rownum, position] still returns data frame if it's minus, so position < 0 should be caught here
          NA
        } else {
          column[index]
        }
      })
    } else {
      sapply(column, function(column){
        column[position]
      })
    }
  }
}

#--------------------------------------------------------------------------------#
#  GET DISTANCE BETWEEN TWO ZIP CODES BASED ON THEIR LATITUDE, LONGITUDE         #
#--------------------------------------------------------------------------------#
get_geo_distance = function(long1, lat1, long2, lat2, units = "miles") {
  longlat1 = purrr::map2(long1, lat1, function(x,y) c(x,y))
  longlat2 = purrr::map2(long2, lat2, function(x,y) c(x,y))
  distance_list = purrr::map2(longlat1, longlat2, function(x,y) geosphere::distHaversine(x, y))
  distance_m = list_extract(distance_list, position = 1)
  if (units == "km") {
    distance = distance_m / 1000.0;
  }
  else if (units == "miles") {
    distance = distance_m / 1609.344
  }
  else {
    distance = distance_m
    # This will return in meter as same way as distHaversine function. 
  }
  distance
}

get_geo_distance(-158.523138, 59.040181, -91.848847, 35.246445)
